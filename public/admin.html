<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Admin – Temple of Logic</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body>

<button id="logout">Logout</button>

<h1>Klassen</h1>
<input id="class-name" placeholder="Neue Klasse">
<button id="add-class">Hinzufügen</button>
<div id="classes"></div>

<h1>Schüler</h1>
<input id="student-name" placeholder="Benutzername">
<input id="student-pass" placeholder="Passwort">
<button id="add-student">Hinzufügen</button>
<div id="students"></div>

<h1>Missionen</h1>
<form id="mission-form" enctype="multipart/form-data">
  <input name="title" placeholder="Titel">
  <input name="xp_value" placeholder="XP">
  <input name="description" placeholder="Beschreibung">
  <label><input type="checkbox" name="allow_upload"> Upload erlaubt</label>
  <input type="file" name="image">
  <button>Speichern</button>
</form>
<div id="missions"></div>

<h1>XP Vergabe</h1>
<input id="xp" placeholder="XP">
<select id="mission-select"></select>
<button id="xp-selected">An ausgewählte</button>
<button id="xp-all">An alle</button>

<script>
async function api(url, opts) {
  const res = await fetch(url, {
    credentials: "same-origin",
    ...opts
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}

document.getElementById("logout").onclick = async () => {
  await api("/api/logout", { method: "POST" });
  location.href = "/login";
};

async function loadClasses() {
  const c = await api("/api/admin/classes");
  const box = document.getElementById("classes");
  box.innerHTML = "";
  c.forEach(k => {
    const div = document.createElement("div");
    div.innerHTML = `
      ${k.is_active ? "(aktiv)" : ""}
      ${k.name}
      <button data-id="${k.id}" class="act">Aktivieren</button>
      <button data-id="${k.id}" class="del">Löschen</button>
    `;
    box.appendChild(div);

    div.querySelector(".act").onclick = () =>
      api("/api/admin/classes/" + k.id, { method: "PATCH" }).then(loadClasses);

    div.querySelector(".del").onclick = () =>
      api("/api/admin/classes/" + k.id, { method: "DELETE" }).then(loadClasses);
  });
}

document.getElementById("add-class").onclick = () => {
  api("/api/admin/classes", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name: class-name.value })
  }).then(loadClasses);
};

async function loadStudents() {
  const s = await api("/api/admin/students");
  const box = document.getElementById("students");
  box.innerHTML = "";
  s.forEach(st => {
    const div = document.createElement("div");
    div.innerHTML = `
      <input type="checkbox" class="chk" value="${st.id}">
      ${st.username} (${st.xp} XP)
      <button data-id="${st.id}" class="del">Löschen</button>
    `;
    box.appendChild(div);
    div.querySelector(".del").onclick = () =>
      api("/api/admin/students/" + st.id, { method: "DELETE" }).then(loadStudents);
  });
}

document.getElementById("add-student").onclick = () => {
  api("/api/admin/students", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      username: student-name.value,
      password: student-pass.value
    })
  }).then(loadStudents);
};

async function loadMissions() {
  const m = await api("/api/admin/missions");
  const box = document.getElementById("missions");
  const sel = document.getElementById("mission-select");
  box.innerHTML = "";
  sel.innerHTML = `<option value="">–</option>`;
  m.forEach(ms => {
    const div = document.createElement("div");
    div.innerHTML = `
      ${ms.title} (${ms.xp_value} XP)
      <button data-id="${ms.id}" class="del">Löschen</button>
    `;
    box.appendChild(div);

    sel.innerHTML += `<option value="${ms.id}">${ms.title}</option>`;

    div.querySelector(".del").onclick = () =>
      api("/api/admin/missions/" + ms.id, { method: "DELETE" }).then(() => {
        loadMissions();
      });
  });
}

document.getElementById("mission-form").onsubmit = (e) => {
  e.preventDefault();
  const fd = new FormData(e.target);
  fetch("/api/admin/missions", {
    method: "POST",
    body: fd,
  }).then(() => {
    e.target.reset();
    loadMissions();
  });
};

document.getElementById("xp-selected").onclick = () => {
  const ids = [...document.querySelectorAll(".chk:checked")].map(c => Number(c.value));
  const xp = Number(document.getElementById("xp").value);
  const missionId = document.getElementById("mission-select").value || null;

  api("/api/admin/xp", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ studentIds: ids, xp, missionId })
  }).then(loadStudents);
};

document.getElementById("xp-all").onclick = () => {
  const xp = Number(document.getElementById("xp").value);
  const missionId = document.getElementById("mission-select").value || null;

  api("/api/admin/xp", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ all: true, xp, missionId })
  }).then(loadStudents);
};

loadClasses();
loadStudents();
loadMissions();
</script>

</body>
</html>
