<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Admin – Temple of Logic</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #111;
      color: #fff;
      margin: 0;
      padding: 20px;
    }

    h2 {
      background: #222;
      padding: 10px;
      border-radius: 5px;
    }

    .section {
      background: #1d1d1d;
      padding: 15px;
      margin-top: 20px;
      border-radius: 8px;
    }

    input, select {
      width: 250px;
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      border: none;
    }

    button {
      padding: 8px 14px;
      margin-top: 8px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #6a00ff;
      color: white;
    }

    button:hover {
      background: #5500cc;
    }

    .item-row {
      background: #2a2a2a;
      padding: 8px;
      border-radius: 4px;
      margin-top: 5px;
      display: flex;
      justify-content: space-between;
    }

    .danger {
      background: #aa0000;
    }
    .danger:hover {
      background: #880000;
    }

    #logout-btn {
      background: #444;
      float: right;
    }
    #logout-btn:hover {
      background: #333;
    }
  </style>
</head>
<body>

<button id="logout-btn" onclick="logout()">Logout</button>
<h1>Admin-Bereich</h1>

<!-- Klassenverwaltung -->
<div class="section">
  <h2>Klassen</h2>

  <input id="class-name" placeholder="Klassenname">
  <button onclick="createClass()">Klasse anlegen</button>

  <h3>Vorhandene Klassen</h3>
  <div id="class-list">Lade Klassen...</div>
</div>


<!-- Missionenverwaltung -->
<div class="section">
  <h2>Missionen</h2>

  <input id="mission-name" placeholder="Missionsname">
  <input id="mission-xp" type="number" placeholder="XP">
  <input id="mission-image" type="file">

  <button onclick="createMission()">Mission anlegen</button>

  <h3>Vorhandene Missionen</h3>
  <div id="mission-list">Lade Missionen...</div>
</div>


<script>
/* ---------- API HELFER ---------- */
async function api(url, method = "GET", data = null, isFile = false) {
  const options = { method };

  if (data && !isFile) {
    options.headers = { "Content-Type": "application/json" };
    options.body = JSON.stringify(data);
  }

  if (isFile) {
    options.body = data;
  }

  const res = await fetch(url, options);

  if (!res.ok) {
    console.error("API Error:", res.status);
    return null;
  }
  return await res.json();
}

/* ---------- LOGIN / LOGOUT ---------- */
async function logout() {
  await fetch("/api/logout", { method: "POST" });
  window.location.href = "/login";
}

/* ---------- KLASSEN ---------- */
async function loadClasses() {
  const list = document.getElementById("class-list");
  const data = await api("/api/admin/classes");

  if (!data) {
    list.innerHTML = "<p>Fehler beim Laden</p>";
    return;
  }

  list.innerHTML = "";
  data.forEach(cls => {
    const row = document.createElement("div");
    row.className = "item-row";

    row.innerHTML = `
      <span>${cls.class_name}</span>
      <div>
        <button class="danger" onclick="deleteClass(${cls.id})">Löschen</button>
      </div>
    `;
    list.appendChild(row);
  });
}

async function createClass() {
  const name = document.getElementById("class-name").value.trim();
  if (!name) return alert("Bitte Name eingeben");

  await api("/api/admin/classes", "POST", { name });
  document.getElementById("class-name").value = "";
  loadClasses();
}

async function deleteClass(id) {
  await api(`/api/admin/classes/${id}`, "DELETE");
  loadClasses();
}

/* ---------- MISSIONEN ---------- */
async function loadMissions() {
  const list = document.getElementById("mission-list");
  const data = await api("/api/admin/missions");

  if (!data) {
    list.innerHTML = "<p>Fehler beim Laden</p>";
    return;
  }

  list.innerHTML = "";
  data.forEach(m => {
    const row = document.createElement("div");
    row.className = "item-row";

    row.innerHTML = `
      <span>${m.name} – ${m.xp} XP</span>
      <button class="danger" onclick="deleteMission(${m.id})">Löschen</button>
    `;
    list.appendChild(row);
  });
}

async function createMission() {
  const name = document.getElementById("mission-name").value.trim();
  const xp = parseInt(document.getElementById("mission-xp").value.trim());
  const file = document.getElementById("mission-image").files[0];

  if (!name || !xp) return alert("Bitte Name und XP eingeben");

  const form = new FormData();
  form.append("name", name);
  form.append("xp", xp);
  if (file) form.append("image", file);

  await api("/api/admin/missions", "POST", form, true);

  document.getElementById("mission-name").value = "";
  document.getElementById("mission-xp").value = "";
  document.getElementById("mission-image").value = "";

  loadMissions();
}

async function deleteMission(id) {
  await api(`/api/admin/missions/${id}`, "DELETE");
  loadMissions();
}

/* ---------- INIT ---------- */
function init() {
  loadClasses();
  loadMissions();
  setInterval(loadClasses, 10000);
  setInterval(loadMissions, 10000);
}

init();
</script>

</body>
</html>
