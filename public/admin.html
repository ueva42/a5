<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Admin – Temple of Logic</title>
  <style>
    body {
      font-family: Arial;
      background: #f3f3f3;
      padding: 20px;
    }

    h2 {
      margin-top: 40px;
    }

    .card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      box-shadow: 0 0 5px #ccc;
    }

    button {
      margin-top: 10px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border-bottom: 1px solid #ccc;
      padding: 6px;
    }

    img {
      max-height: 60px;
    }
  </style>
</head>
<body>

<h1>Adminbereich</h1>
<button onclick="logout()">Logout</button>

<!-- ========================================== -->
<!--                 KLASSEN                    -->
<!-- ========================================== -->
<div class="card">
  <h2>Klassen</h2>

  <input id="className" placeholder="Neue Klasse…" />
  <button onclick="createClass()">Klasse anlegen</button>

  <table>
    <thead>
      <tr><th>Name</th><th>Aktion</th></tr>
    </thead>
    <tbody id="classList"></tbody>
  </table>
</div>

<!-- ========================================== -->
<!--                SCHÜLER                     -->
<!-- ========================================== -->
<div class="card">
  <h2>Schüler der aktiven Klasse</h2>

  <label>Klasse wählen:</label>
  <select id="studentClassSelect" onchange="loadStudents()"></select>

  <br><br>

  <input id="studentName" placeholder="Schülername" />
  <input id="studentPass" placeholder="Passwort" />
  <button onclick="createStudent()">Schüler anlegen</button>

  <table>
    <thead>
      <tr><th>Name</th><th>XP</th><th>Aktion</th></tr>
    </thead>
    <tbody id="studentList"></tbody>
  </table>
</div>

<!-- ========================================== -->
<!--                MISSIONEN                    -->
<!-- ========================================== -->
<div class="card">
  <h2>Missionen</h2>

  <input id="missionTitle" placeholder="Titel" />
  <input id="missionXP" type="number" placeholder="XP" />
  <input id="missionImg" type="file" />
  <button onclick="createMission()">Mission anlegen</button>

  <table>
    <thead>
      <tr><th>Titel</th><th>XP</th><th>Bild</th><th>Aktion</th></tr>
    </thead>
    <tbody id="missionList"></tbody>
  </table>
</div>

<!-- ========================================== -->
<!--                XP VERGABE                  -->
<!-- ========================================== -->
<div class="card">
  <h2>XP vergeben</h2>

  <label>Klasse wählen:</label>
  <select id="xpClassSelect" onchange="loadStudents()"></select>

  <br><br>

  <input id="xpAmount" type="number" placeholder="XP" />
  <button onclick="giveXP()">XP vergeben</button>

  <h3>Mission XP vergeben</h3>

  <select id="xpMissionSelect"></select>
  <button onclick="giveMissionXP()">Mission XP vergeben</button>

</div>

<script>
// =======================================
// LOGOUT
// =======================================
function logout() {
  window.location.href = "/logout";
}

// =======================================
// KLASSEN LADEN
// =======================================
async function loadClasses() {
  const r = await fetch("/api/admin/classes");
  const data = await r.json();

  const list = document.getElementById("classList");
  const selects = [
    document.getElementById("studentClassSelect"),
    document.getElementById("xpClassSelect")
  ];

  list.innerHTML = "";
  selects.forEach(s => s.innerHTML = "");

  data.forEach(c => {
    // Tabellenanzeige
    list.innerHTML += `
      <tr>
        <td>${c.name}</td>
        <td><button onclick="deleteClass(${c.id})">Löschen</button></td>
      </tr>
    `;

    // Select-Felder
    selects.forEach(s => {
      s.innerHTML += `<option value="${c.id}">${c.name}</option>`;
    });
  });
}

async function createClass() {
  const name = document.getElementById("className").value.trim();
  if (!name) return alert("Name eingeben!");

  await fetch("/api/admin/classes", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ name })
  });
  loadClasses();
}

async function deleteClass(id) {
  await fetch(`/api/admin/classes/${id}`, { method: "DELETE" });
  loadClasses();
}

// =======================================
// SCHÜLER LADEN
// =======================================
async function loadStudents() {
  const classId = document.getElementById("studentClassSelect").value;
  if (!classId) return;

  const r = await fetch(`/api/admin/students/${classId}`);
  const data = await r.json();

  const tbl = document.getElementById("studentList");
  tbl.innerHTML = "";

  data.forEach(s => {
    tbl.innerHTML += `
      <tr>
        <td>${s.username}</td>
        <td>${s.xp}</td>
        <td><button onclick="deleteStudent(${s.id})">Löschen</button></td>
      </tr>
    `;
  });

  // auch für XP-Vergabe nutzbar
  window.studentCache = data;
}

async function createStudent() {
  const username = document.getElementById("studentName").value.trim();
  const password = document.getElementById("studentPass").value.trim();
  const class_id = document.getElementById("studentClassSelect").value;

  if (!username || !password) return alert("Name + Passwort!");

  await fetch("/api/admin/students", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ username, password, class_id })
  });

  loadStudents();
}

async function deleteStudent(id) {
  await fetch(`/api/admin/students/${id}`, { method: "DELETE" });
  loadStudents();
}

// =======================================
// MISSIONEN
// =======================================
async function loadMissions() {
  const r = await fetch("/api/admin/missions");
  const data = await r.json();

  const list = document.getElementById("missionList");
  const xpSelect = document.getElementById("xpMissionSelect");

  list.innerHTML = "";
  xpSelect.innerHTML = "";

  data.forEach(m => {
    list.innerHTML += `
      <tr>
        <td>${m.title}</td>
        <td>${m.xp}</td>
        <td>${m.image_path ? `<img src="${m.image_path}">` : "-"}</td>
        <td><button onclick="deleteMission(${m.id})">Löschen</button></td>
      </tr>
    `;

    xpSelect.innerHTML += `
      <option value="${m.id}" data-xp="${m.xp}">
        ${m.title} (${m.xp} XP)
      </option>
    `;
  });
}

async function createMission() {
  const title = document.getElementById("missionTitle").value;
  const xp = document.getElementById("missionXP").value;
  const img = document.getElementById("missionImg").files[0];

  const form = new FormData();
  form.append("title", title);
  form.append("xp", xp);
  if (img) form.append("image", img);

  await fetch("/api/admin/missions", {
    method: "POST",
    body: form
  });

  loadMissions();
}

async function deleteMission(id) {
  await fetch(`/api/admin/missions/${id}`, { method: "DELETE" });
  loadMissions();
}

// =======================================
// XP VERGEBEN
// =======================================
async function giveXP() {
  const amount = parseInt(document.getElementById("xpAmount").value);
  if (!amount) return alert("XP eingeben!");

  const ids = window.studentCache.map(s => s.id);

  await fetch("/api/admin/xp/give", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ studentIds: ids, amount })
  });

  loadStudents();
}

async function giveMissionXP() {
  const missionId = document.getElementById("xpMissionSelect").value;
  const xp = parseInt(
    document.querySelector(`#xpMissionSelect option[value='${missionId}']`).dataset.xp
  );

  const ids = window.studentCache.map(s => s.id);

  await fetch("/api/admin/xp/give", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ studentIds: ids, amount: xp })
  });

  loadStudents();
}

// =======================================
// INIT
// =======================================
async function init() {
  await loadClasses();
  await loadMissions();
  await loadStudents();

  setInterval(loadStudents, 3000);
}

init();
</script>

</body>
</html>
